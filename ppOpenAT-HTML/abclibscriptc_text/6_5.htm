
<html>
<head>
<title>pass4.cpp ò_óùÉ`ÉÉÅ[Ég</title><base target="main">
<link rel ="stylesheet" type="text/css" href="stylesheet.css" title="stylesheet">
<meta http-equiv="Content-Type" content="text/html;charset=Shift_JIS">
</head>

<body bgcolor="#ffffff">

<div align="right"><font size="2">ABCLibScriptC ÉvÉçÉWÉFÉNÉg</font></div>

<table width=100% bgcolor="#e6e6fa" class="titlebgcolor" border="1" cellpadding="7" cellspacing="0">
<tr>
    <td><font class="titlefont">5.5. pass4.cpp ò_óùÉ`ÉÉÅ[Ég</font></td>
</tr>
</table>

<p></p>
<pre>
ÉtÉ@ÉCÉãò_óùÉ`ÉÉÅ[Ég

     1  +--- /*=====================================================================*
     2  |     *                                                                     *   
     3  |     *   Software Name : ppOpen-AT                                         *   
     4  |     *         Version : 0.1                                               *   
     5  |     *                                                                     *   
     6  |     *   License                                                           *   
     7  |     *     This file is part of ppOpen-AT.                                 *   
     8  |     *     ppOpen-AT is a free software, you can use it under the terms    *   
     9  |     *     of The MIT License (MIT). See LICENSE file and User's guide     *   
    10  |     *     for more details.                                               *   
    11  |     *                                                                     *   
    12  |     *   ppOpen-HPC project:                                               *   
    13  |     *     Open Source Infrastructure for Development and Execution of     *   
    14  |     *     Large-Scale Scientific Applications on Post-Peta-Scale          *   
    15  |     *     Supercomputers with Automatic Tuning (AT).                      *   
    16  |     *                                                                     *   
    17  |     *   Organizations:                                                    *   
    18  |     *     The University of Tokyo                                         *   
    19  |     *       - Information Technology Center                               *   
    20  |     *       - Atmosphere and Ocean Research Institute (AORI)              *   
    21  |     *       - Graduate School of Interdisciplinary Information Studies    *   
    22  |     *         /Earthquake Research Institute (ERI)                        *   
    23  |     *       - Graduate School of Frontier Science                         *   
    24  |     *     Kyoto University                                                *   
    25  |     *       - Academic Center for Computing and Media Studies             *   
    26  |     *     Japan Agency for Marine-Earth Science and Technology (JAMSTEC)  *   
    27  |     *                                                                     *   
    28  |     *   Sponsorship:                                                      *   
    29  |     *     Japan Science and Technology Agency (JST), Basic Research       *   
    30  |     *     Programs: CREST, Development of System Software Technologies    *   
    31  |     *     for post-Peta Scale High Performance Computing.                 *   
    32  |     *                                                                     *   
    33  |     *   Copyright (c) 2012                                                *   
    34  |     *      Information Technology Center, The University of Tokyo         *   
    35  |     *                                                                     *   
    36  |     *=====================================================================*/  
    37  +--- /*----------------------------------------------------------------------------*/
    38  +--- //
    39  |    //  Ê¶ÇËÉíÅ                                                                      
    40  |    //    „Éë„ÇπÔºî                                                                  
    41  |    //                                                                               
    42  |    //  ‰ΩúÊàêËÄÖ                                                                    
    43  |    //                                                                               
    44  |    /*----------------------------------------------------------------------------*/ 
    45  |                                                                                     
    46  +--- #include &quot;TuneRegion.h&quot;
    47  |    
    48  +--- //
    49  |    // ÁîüÊàê                                                                                              
    50  |    //                                                                                                     
    51  |    /*----------------------------------------------------------------------------*/                       
    52  |    //                                                                                                     
    53  |    //  1.ÊóÅEÊúÉÉË™ûÂêç                                                                                   
    54  |    //                                                                                                     
    55  |    //  2.„Éë„É©„ÉÅB„ÇÉ\Ë™ÉÉÊòé                                                                            
    56  |    //    aTokenList  „Éà„Éº„ÇÉb„ÉÉE„ÉÉF„ÇÉP„Éà                                                            
    57  |    //    aValDataList  Â§âÊï∞„Éá„Éº„ÇÉ\„ÉÉF„ÇÉP„Éà                                                        
    58  |    //    aTuneRegionList ÁîüÊàê„Åï„Çå„ÇãTuneRegion„ÅÉáÊ†ÉVÁ¥çÂÖà„ÉÉF„ÇÉP„Éà                               
    59  |    //                                                                                                     
    60  |    //  3.Ê¶ÇËÉíÅ                                                                                          
    61  |    //    „Éë„ÇπÔºî„ÇØ„ÉÉD„ÇÉPÁîüÊàê„ÄÇÂÅAâÊï∞„ÅÉáÂàùÊúüÂåñ„Å®„ÄÅÂÉVïÊï∞„Éá„Éº„ÇÉ\„ÅÉáË§áÂÜô„ÇíËÅBå„ÅÜ„ÄÇ  
    62  |    //                                                                                                     
    63  |    //  4.Ê©üËÉΩË™ÉÉÊòé                                                                                    
    64  |    //                                                                                                     
    65  |    //  5.ÊàÉT„ÇäÂÄÅA                                                                                      
    66  |    //                                                                                                     
    67  |    //  6.ÂÇôËÄÉ                                                                                           
    68  |    //                                                                                                     
    69  |    /*----------------------------------------------------------------------------*/                       
        |  +------------------------------------------------------------------------------+ 
    70  +--+ TPass4::TPass4(TList *aTokenList,TList *aValDataList,TList *aTuneRegionList) | 
    71  |  | {                                                                            | 
        |  +--+---------------------------------------------------------------------------+ 
    72  |     +--- string DirName;
    73  |     +--- string fname;
    74  |     |    
    75  |     +--- TokenList = aTokenList;
    76  |     +--- ValDataList = aValDataList;
    77  |     +--- TuneRegionList = aTuneRegionList;
    78  |     |    
    79  |     +--- OAT_ValList = new TStringList;
    80  |     |    
    81  |     +--- fname = MainF-&gt;SrcFileNameList.Strings[0];
    82  |     +--- DirName = fname.substr(0,fname.rfind(&quot;/&quot;)+1);
    83  |     +--- fname = fname.substr(fname.rfind(&quot;/&quot;)+1);
        |     |  +--------------------+ 
    84  |     +--+ if(DirName == &quot;&quot;){ | 
        |     |  +--+-----------------+ 
    85  |     |     +--- DirName = &quot;./&quot;;
        |     |   +-+---+ 
    86  |     |   |  }  | 
        |     |   +-----+ 
    87  |     +--- //  fname = DirName + &quot;\\OAT/OAT_&quot;+ExtractFileName(fname);
    88  |     +--- fname = DirName + &quot;/OAT/OAT_&quot; + fname;
        |   +-+---+ 
    89  |   |  }  | 
        |   +-----+ 
    90  +--- //
    91  |    // Á†ÉGÊ£Ñ                                                                       
    92  |    //                                                                               
    93  |    /*----------------------------------------------------------------------------*/ 
    94  |    //                                                                               
    95  |    //  1.ÊóÅEÊúÉÉË™ûÂêç                                                             
    96  |    //                                                                               
    97  |    //  2.„Éë„É©„ÉÅB„ÇÉ\Ë™ÉÉÊòé                                                      
    98  |    //                                                                               
    99  |    //  3.Ê¶ÇËÉíÅ                                                                    
   100  |    //    „Éë„ÇπÔºî„ÇØ„ÉÉD„ÇÉPÁ†ÉGÊ£Ñ                                                
   101  |    //                                                                               
   102  |    //  4.Ê©üËÉΩË™ÉÉÊòé                                                              
   103  |    //                                                                               
   104  |    //  5.ÊàÉT„ÇäÂÄÅA                                                                
   105  |    //                                                                               
   106  |    //  6.ÂÇôËÄÉ                                                                     
   107  |    //                                                                               
   108  |    /*----------------------------------------------------------------------------*/ 
        |  +--------------------+ 
   109  +--+ TPass4::~TPass4()  | 
   110  |  | {                  | 
        |  +--+-----------------+ 
   111  |     +--- delete OAT_ValList;
        |   +-+---+ 
   112  |   |  }  | 
        |   +-----+ 
   113  +--- /*----------------------------------------------------------------------------*/
   114  |    //                                                                                                                           
   115  |    //  1.ÊóÅEÊúÉÉË™ûÂêç                                                                                                         
   116  |    //                                                                                                                           
   117  |    //  2.„Éë„É©„ÉÅB„ÇÉ\Ë™ÉÉÊòé                                                                                                  
   118  |    //                                                                                                                           
   119  |    //  3.Ê¶ÇËÉíÅ                                                                                                                
   120  |    //    „ÇÉP„ÇÉb„ÉÉF„Éó„Éà„ÇíÂÉáüËÅBå„Åó„ÅÉí„ÉÅ„É•„ÉÉV„Éã„É≥„ÇÅ[„ÉÉF„ÉÉV„ÇÉN„ÉÉ@„ÉÉE„ÇíÁîüÊàê„Åó„ÄÅ„Åù„ÅÉáËßÅvÊûê„ÇíË°å„ÅÜ„ÄÇ  
   121  |    //    ËßÅvÊûêÁÉIêÊûú„ÅÉb„ÄÅÂêÑTTuneRegion„ÇÉb„ÉÉD„ÇÉP„ÅÉá„Éá„Éº„ÇÉ\„ÅÉB„Åó„Å¶‰øùÊåÅ„Åï„Çå„Çã„ÄÇ                              
   122  |    //    „ÇÉP„ÇÉb„ÉÉF„Éó„Éà„ÇíÂÉáüËÅBå„Åô„Çã„Ç®„ÉÉE„ÇÉN„ÉÉE„ÅÉB„Åó„Å¶„ÅÉá‰ΩçÁÉXÉá„ÅÅE„Åë„Å®„ÅÉF„Çã„ÄÇ                           
   123  |    //                                                                                                                           
   124  |    //  4.Ê©üËÉΩË™ÉÉÊòé                                                                                                          
   125  |    //    „ÇÉP„ÇÉb„ÉÉF„Éó„Éà„ÇíÂÉáüËÅBå„Åó„ÅÉí„ÉÅ„É•„ÉÉV„Éã„É≥„ÇÅ[„ÉÉF„ÉÉV„ÇÉN„ÉÉ@„ÉÉE„ÇíÁîüÊàê„Åó„ÄÅ„Åù„ÅÉáËßÅvÊûê„ÇíË°å„ÅÜ„ÄÇ  
   126  |    //    ËßÅvÊûêÁÉIêÊûú„ÅÉb„ÄÅÂêÑTTuneRegion„ÇÉb„ÉÉD„ÇÉP„ÅÉá„Éá„Éº„ÇÉ\„ÅÉB„Åó„Å¶‰øùÊåÅ„Åï„Çå„Çã„ÄÇ                              
   127  |    //    Ë§áÊï∞„ÅÉáTrueRegion„ÅÉHÂØÉZÂøú„Åô„Çã„Åü„ÇÅ„Å´„ÄÅRegion„Åî„Å®„ÅÉá„ÇÉb„ÉÉD„ÇÉP„ÅÉB„Åó„Å¶TuneRegion„ÇíÁîüÊàê             
   128  |    //    „Åô„ÇãÂΩÅu„ÇíÂèñ„Çã„ÄÇ                                                                                                 
   129  |    //    „ÇÉP„ÇÉb„ÉÉF„Éó„Éà„ÅÉáËßÅvÊûê„ÇÇ„ÄÅPass4„ÅÉ@Ê∏à„Åæ„Åõ„ÄÅPass5„ÅÉ@„ÅÉb„ÄÅTuneRegion„ÇÉb„ÉÉD„ÇÉP„ÇíÂèÇÁÖÉ@„Åó„Å¶„ÇÉX     
   130  |    //    „ÉÉV„ÇÉP„ÇíÁîüÊàê„Åô„Çã„ÄÇ                                                                                             
   131  |    //                                                                                                                           
   132  |    //  5.ÊàÉT„ÇäÂÄÅA                                                                                                            
   133  |    //    „ÅÉF„Åó                                                                                                                
   134  |    //                                                                                                                           
   135  |    //  6.ÂÇôËÄÉ                                                                                                                 
   136  |    //                                                                                                                           
   137  |    /*----------------------------------------------------------------------------*/                                             
        |  +----------------------+ 
   138  +--+ void TPass4::Exec()  | 
   139     | {                    | 
           +--+-------------------+ 
   140        +--- int i,j;
   141        +--- TToken *Token;
   142        +--- TScript *Script;
   143        +--- string s;
   144        +--- TTuneRegion *TuneRegion;
   145        |    
   146        +--- //
   147        |    // „Éà„Éº„ÇÉb„ÉÉE„ÅÉáLoop  
   148        |    //                         
              |  +------------------------------------------+ 
   149        +--+ for(i = 0 ; i &lt; TokenList-&gt;Count ; i++){ | 
              |  +--+---------------------------------------+ 
   150        |     +--- Token = (TToken *)TokenList-&gt;Items[i];
              |     |  +----------------------------+ 
   151        |     +--+ if(Token-&gt;Script != NULL){ | 
              |     |  +--+-------------------------+ 
   152        |     |     +--- Script = (TScript *)Token-&gt;Script;
              |     |     |  +------------------------------------+ 
   153        |     |     +--+ if(Script-&gt;ScType == sct_command){ | 
              |     |     |  +--+---------------------------------+ 
   154        |     |     |     +--- //
   155        |     |     |     |    // ABCScript „ÅÉá„ÇÉE„Éû„É≥„Éâ„ÅåÂáÉRÂäõ„Åï„Çå„Çã„ÄÇ                                               
   156        |     |     |     |    // „Åì„Åì„ÅÉ@„ÄÅOAT_xxx = „ÅÉáÂÄÅA„ÅÉáÊâÄÂæó„ÇÇË°å„ÅÜ„ÄÇ                                           
   157        |     |     |     |    // ÁèÉZÁäÉJ„ÅÉ@„ÅÉb„ÄÅÂÉáöÊï∞„ÅÉá„ÅÉ\„Åå‰ÉXÉ\ÁîÉBÂèÉbËÉÉX„ÄÇÔÉVàÂÅAâÊï∞„ÇÑÂÉVè„ÅØ„ÇÉB„ÉÉD„ÉÉVÔºâ   
   158        |     |     |     |    //                                                                                                 
   159        |     |     |     +--- s = Script-&gt;TokStrList-&gt;Strings[0];
              |     |     |     |  +----------------------------------+ 
   160        |     |     |     +--+ if(s.find(&quot;=&quot;) != string::npos){ | 
              |     |     |     |  +--+-------------------------------+ 
   161        |     |     |     |     +--- string ValName,ConstStr;
   162        |     |     |     |     +--- long Data;
   163        |     |     |     |     |    
   164        |     |     |     |     +--- ValName = Trim(s.substr(0,s.find(&quot;=&quot;)-1));
   165        |     |     |     |     +--- ConstStr = Trim(s.substr(s.find(&quot;=&quot;)+1,s.length()));
              |     |     |     |     |  +------+ 
   166        |     |     |     |     +--+ try{ | 
              |     |     |     |     |  +--+---+ 
   167        |     |     |     |     |     +--- Data = atoi(ConstStr.c_str());
              |     |     |     |     |   +-+---+ 
   168        |     |     |     |     |   |  }  | 
              |     |     |     |     |   +-----+ 
              |     |     |     |     |  +--------------+ 
   168        |     |     |     |     +--+ catch(...){  | 
              |     |     |     |     |  +--+-----------+ 
   169        |     |     |     |     |     +--- //                      MainF-&gt;err(&quot;OATÂ§âÊï∞„ÅÉHÊïÉGÊïÅ[ÂÆöÊï∞‰ªÅEÂ§ñ„ÅåË®ÉÖÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ [&quot;+s+&quot;]&quot;);
   170        |     |     |     |     |     +--- MainF-&gt;ErrMessage(i,&quot;OAT variable is not const int. [&quot;+s+&quot;]&quot;);
              |     |     |     |     |     |  +----------+ 
   171        |     |     |     |     |     +--+ return;  | 
              |     |     |     |     |     |  +----------+ 
              |     |     |     |     |   +-+---+ 
   172        |     |     |     |     |   |  }  | 
              |     |     |     |     |   +-----+ 
   173        |     |     |     |     +--- // Â§âÊï∞„ÅÉHËøÉXÂä† ÔºíÂõûË®ÉÖÂÆö„ÇÇOK„ÅÉB„Åó„Åü„ÄÇ2010/08/26
              |     |     |     |     |  +------------------------------------------+ 
   174        |     |     |     |     +--+ if(OAT_ValList-&gt;IndexOf(ValName) != -1){ | 
              |     |     |     |     |  +--+---------------------------------------+ 
   175        |     |     |     |     |     +--- //                      MainF-&gt;err(&quot;OATÂ§âÊï∞„ÅåÔÉVíÂÉRÉíË®ÉÖÂÆö„Åï„Çå„Å¶„ÅÑ„Åæ„Åô„ÄÇ [&quot;+s+&quot;]&quot;);
   176        |     |     |     |     |     |    //                      return;                                                                  
              |     |     |     |     |   +-+---+ 
   177        |     |     |     |     |   |  }  | 
              |     |     |     |     |   +-+---+ 
              |     |     |     |     |   +-+-------+ 
   177        |     |     |     |     |   |  else{  | 
              |     |     |     |     |   +-+-------+ 
   178        |     |     |     |     |     +--- OAT_ValList-&gt;AddObject(ValName,(void *)Data);
   179        |     |     |     |     |     +--- MainF-&gt;print(&quot;OAT variable: &quot;+ s);
              |     |     |     |     |   +-+---+ 
   180        |     |     |     |     |   |  }  | 
              |     |     |     |     |   +-----+ 
              |     |     |     |   +-+---+ 
   181        |     |     |     |   |  }  | 
              |     |     |     |   +-----+ 
              |     |     |     |  +--------------------------------------------+ 
   182        |     |     |     +--+ for(int j = 0 ; j &lt; Token-&gt;Indent ; j++){  | 
              |     |     |     |  +--+-----------------------------------------+ 
   183        |     |     |     |     +--- s = &quot;  &quot;+s;
              |     |     |     |   +-+---+ 
   184        |     |     |     |   |  }  | 
              |     |     |     |   +-----+ 
              |     |     |   +-+---+ 
   185        |     |     |   |  }  | 
              |     |     |   +-+---+ 
              |     |     |   +-+---------------------------------------------------------------------------+ 
   185        |     |     |   |  else if(Script-&gt;ScRegion == scr_start){    // „ÉÉF„ÉÉV„ÇÉN„ÉÉ@„ÉÉEÈñãÂÉ@ã  | 
              |     |     |   +-+---------------------------------------------------------------------------+ 
   186        |     |     |     +--- TuneRegion = new TTuneRegion(this,i);   // „ÉÉF„ÉÉV„ÇÉN„ÉÉ@„ÉÉEÁîüÊàê
   187        |     |     |     +--- Script-&gt;TuneRegion = TuneRegion;
   188        |     |     |     +--- TuneRegionList-&gt;Add(TuneRegion);        // „ÉÉF„ÇÉP„Éà„Å´ËøÉXÂä†
   189        |     |     |     +--- // ÂüÉRÊúÉÉ„Éë„É©„ÉÅB„ÇÉ\ÂêçËÅBÉBÁ§ÉR„ÇíËÉ\ÉXÂä† 2009/03/05
   190        |     |     |     +--- s = &quot;&quot;;
              |     |     |     |  +------------------------------------------------------------+ 
   191        |     |     |     +--+ for(int j = 0 ; j &lt; TuneRegion-&gt;BaseValList-&gt;Count ; j++){ | 
              |     |     |     |  +--+---------------------------------------------------------+ 
              |     |     |     |     |  +--------------+ 
   192        |     |     |     |     +--+ if(s != &quot;&quot;){ | 
              |     |     |     |     |  +--+-----------+ 
   193        |     |     |     |     |     +--- s += &quot;,&quot;;
              |     |     |     |     |   +-+---+ 
   194        |     |     |     |     |   |  }  | 
              |     |     |     |     |   +-----+ 
   195        |     |     |     |     +--- s += TuneRegion-&gt;BaseValList-&gt;Strings[j];
   196        |     |     |     |     |    
              |     |     |     |   +-+---+ 
   197        |     |     |     |   |  }  | 
              |     |     |     |   +-----+ 
   198        |     |     |     +--- MainF-&gt;print(&quot;Base Paramater (BPset): &quot;+ s);
              |     |     |   +-+---+ 
   199        |     |     |   |  }  | 
              |     |     |   +-----+ 
              |     |   +-+---+ 
   200        |     |   |  }  | 
              |     |   +-----+ 
              |   +-+---+ 
   201        |   |  }  | 
              |   +-----+ 
   202        +--- //
   203        |    // TuneRegionList„ÇíTuneRegion-&gt;NumberÈ†Ü„Å´‰∏Éí„ÅÉP„Çã„ÄÇ   
   204        |    //                                                           
              |  +------------------------------------------------+ 
   205        +--+ for(i = 0 ; i &lt; TuneRegionList-&gt;Count ; i++){  | 
              |  +--+---------------------------------------------+ 
              |     |  +--------------------------------------------------+ 
   206        |     +--+ for(j = i+1 ; j &lt; TuneRegionList-&gt;Count ; j++){  | 
              |     |  +--+-----------------------------------------------+ 
              |     |     |  +--------------------------------------------------------------+ 
   207        |     |     +--+ if(((TTuneRegion *)TuneRegionList-&gt;Items[i])-&gt;Number &gt;       | 
   208        |     |     |  |         ((TTuneRegion *)TuneRegionList-&gt;Items[j])-&gt;Number){  | 
              |     |     |  +--+-----------------------------------------------------------+ 
   209        |     |     |     +--- TuneRegionList-&gt;Exchange(i,j);
              |     |     |   +-+---+ 
   210        |     |     |   |  }  | 
              |     |     |   +-----+ 
              |     |   +-+---+ 
   211        |     |   |  }  | 
              |     |   +-----+ 
              |   +-+---+ 
   212        |   |  }  | 
              |   +-----+ 
            +-+---+ 
   213      |  }  | 
            +-----+ 
</pre>


</body>
</html>

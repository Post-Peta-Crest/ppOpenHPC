module atm
use jcup_interface
use field_common
use component_field, only : component_field_type
private

public :: atm_init
public :: atm_run
public :: atm_fin

integer :: DIV_X
integer :: DIV_Y
integer :: my_comm, my_group, my_rank, my_size

type(component_field_type) :: field, field3d, field_land

integer :: send_grid_ao(GNXO*GNYO)
integer :: recv_grid_ao(GNXO*GNYO)
integer :: send_grid_oa(GNXA*GNYA)
integer :: recv_grid_oa(GNXA*GNYA)

integer :: send_grid_ac(GNXA*GNYA*GNZA)
integer :: recv_grid_ac(GNXA*GNYA*GNZA)
integer :: send_grid_ca(GNXA*GNYA*GNZA)
integer :: recv_grid_ca(GNXA*GNYA*GNZA)

integer :: send_grid_al(GNXL*GNYL)
integer :: recv_grid_al(GNXL*GNYL)
integer :: send_grid_la(GNXA*GNYA)
integer :: recv_grid_la(GNXA*GNYA)

integer :: send_grid_ai(GNXI*GNYI)
integer :: recv_grid_ai(GNXI*GNYI)
integer :: send_grid_ia(GNXA*GNYA)
integer :: recv_grid_ia(GNXA*GNYA)

integer :: send_grid_li(GNXI*GNYI)
integer :: recv_grid_li(GNXI*GNYI)
integer :: send_grid_il(GNXL*GNYL)
integer :: recv_grid_il(GNXL*GNYL)

integer :: itime(6)
integer :: itimel(6)
integer :: delta_t

contains

!======================================================================================================

subroutine atm_init()
  use jcup_interpolation_sample
  use field_def, only : init_field_def, set_field_def, cal_mn, get_local_field, cal_grid_index, &
                        set_grid_mapping, set_grid_mapping_3d
  use component_field, only : init_field, init_field_data
  use dynamics, only : dynamics_init
  use land, only : land_init_grid, land_init_data, land_put_initial_data
  implicit none
  integer :: lis, lie, ljs, lje
  integer :: ij, i, j, k
  integer, allocatable :: grid_index(:)
  integer :: comp_id(2)

  call jcup_set_new_comp("atm")
  call jcup_set_new_comp("land")
  call jcup_initialize("atm")

  call init_interpolation(6,1,1)

  call jcup_get_mpi_parameter("atm", my_comm, my_group, my_size, my_rank)
  call cal_mn(my_size, DIV_X, DIV_Y)

  call init_field_def(2)

  call set_field_def("atm", "atm_grid_2d", GNXA, GNYA, 1, 2, DIV_X, DIV_Y)
  call set_field_def("atm", "atm_grid_3d", GNXA, GNYA, GNZA, 2, DIV_X, DIV_Y)
  call get_local_field(component_name = "atm", grid_name = "atm_grid_2d", &
                       local_is = lis, local_ie = lie, local_js = ljs, local_je = lje)
  call init_field(field, "atm_grid_2d", lis, lie, ljs, lje, 1, 1)
  call init_field(field3d, "atm_grid_3d", lis, lie, ljs, lje, 1, GNZA)
  call init_field(field_land, "atm_grid_2d", lis, lie, ljs, lje, 1, 1)

  call cal_grid_index("atm","atm_grid_2d", field%grid_index)
  call cal_grid_index("atm","atm_grid_3d", field3d%grid_index)

  call jcup_def_grid(field%grid_index, "atm", "atm_grid_2d")
  call jcup_def_grid(field3d%grid_index, "atm", "atm_grid_3d")


  call land_init_grid()

  call jcup_end_grid_def()

  call init_field_data(field, GN25, 5, 1)
  call init_field_data(field_land, 1, 1, 2)
  call init_field_data(field3d, 1, 1, 1)

  call jcup_def_varp(field%varp(1)%varp_ptr, "a_2d_1", "atm_grid_2d")
  call jcup_def_varp(field%varp(2)%varp_ptr, "a_2d_2", "atm_grid_2d")
  call jcup_def_varp(field%varp(3)%varp_ptr, "a_2d_3", "atm_grid_2d")
  call jcup_def_varp(field%varp(4)%varp_ptr, "a_25d_1", "atm_grid_2d", GN25)
  call jcup_def_varp(field%varp(5)%varp_ptr, "a_25d_2", "atm_grid_2d", GN25)
  call jcup_def_varg(field%varg(1)%varg_ptr, "oa_1", "atm_grid_2d")

  call jcup_def_varp(field3d%varp(1)%varp_ptr, "a_3d_1", "atm_grid_3d")
  call jcup_def_varg(field3d%varg(1)%varg_ptr, "ca_1", "atm_grid_3d")

  call jcup_def_varg(field_land%varg(1)%varg_ptr, "la_1", "atm_grid_2d")
  call jcup_def_varg(field_land%varg(2)%varg_ptr, "ia_1", "atm_grid_2d")


  call land_init_data()

  call jcup_end_var_def()

  call set_grid_mapping("atm", "atm_grid_2d", GNXA, GNYA, "ocn", "ocn_grid", GNXO, GNYO, send_grid_ao,recv_grid_ao)
  call set_grid_mapping("ocn", "ocn_grid", GNXO, GNYO, "atm", "atm_grid_2d", GNXA, GNYA, send_grid_oa,recv_grid_oa)

  call jcup_set_mapping_table("atm", "atm", "atm_grid_2d", "ocn", "ocn_grid", 1, send_grid_ao, recv_grid_ao)
  call jcup_set_mapping_table("atm", "ocn", "ocn_grid", "atm", "atm_grid_2d", 1, send_grid_oa, recv_grid_oa)
  call set_operation_index("atm","ocn",1)

  call set_grid_mapping_3d("atm","atm_grid_3d", GNXA, GNYA, GNZA, "chm", "chm_grid", GNXC, GNYC, GNZC, send_grid_ac, recv_grid_ac)
  call set_grid_mapping_3d("chm","chm_grid", GNXC, GNYC, GNZC, "atm", "atm_grid_3d", GNXA, GNYA, GNZA, send_grid_ca, recv_grid_ca)

  call jcup_set_mapping_table("atm", "atm", "atm_grid_3d", "chm", "chm_grid", 1, send_grid_ac, recv_grid_ac)
  call jcup_set_mapping_table("atm", "chm", "chm_grid", "atm", "atm_grid_3d", 1, send_grid_ca, recv_grid_ca)
  call set_operation_index("atm","chm",1)

  call set_grid_mapping("atm", "atm_grid_2d", GNXA, GNYA, "land", "land_grid", GNXL, GNYL, send_grid_al,recv_grid_al)
  call set_grid_mapping("land", "land_grid", GNXL, GNYL, "atm", "atm_grid_2d", GNXA, GNYA, send_grid_la,recv_grid_la)

  call jcup_set_mapping_table("atm", "atm", "atm_grid_2d", "land", "land_grid", 1, send_grid_al, recv_grid_al)
  call jcup_set_mapping_table("atm", "land", "land_grid", "atm", "atm_grid_2d", 1, send_grid_la, recv_grid_la)
  call set_operation_index("atm","land",1)
  call set_operation_index("land","atm",1)

  call set_grid_mapping("atm", "atm_grid_2d", GNXA, GNYA, "ice", "ice_grid", GNXI, GNYI, send_grid_ai,recv_grid_ai)
  call set_grid_mapping("ice", "ice_grid", GNXI, GNYI, "atm", "atm_grid_2d", GNXA, GNYA, send_grid_ia,recv_grid_ia)
  call jcup_set_mapping_table("atm", "atm", "atm_grid_2d", "ice", "ice_grid", 1, send_grid_ai, recv_grid_ai)
  call jcup_set_mapping_table("atm", "ice", "ice_grid", "atm", "atm_grid_2d", 1, send_grid_ia, recv_grid_ia)
  call set_operation_index("atm","ice",1)


  call jcup_set_mapping_table("land", "ocn", "ocn_grid", "land", "land_grid", 1)
  call jcup_set_mapping_table("land", "land", "land_grid", "ocn", "ocn_grid", 1)
  call set_operation_index("land","ocn",1)

  call set_grid_mapping("land", "land_grid", GNXL, GNYL, "ice", "ice_grid", GNXI, GNYI, send_grid_li,recv_grid_li)
  call set_grid_mapping("ice", "ice_grid", GNXI, GNYI, "land", "land_grid", GNXL, GNYL, send_grid_il,recv_grid_il)
  call jcup_set_mapping_table("land", "land", "land_grid", "ice", "ice_grid", 1, send_grid_li, recv_grid_li)
  call jcup_set_mapping_table("land", "ice", "ice_grid", "land", "land_grid", 1, send_grid_il, recv_grid_il)
  call set_operation_index("land","ice",1)


  itime(1) = 2004
  itime(2) = 12
  itime(3) = 31
  itime(4) = 0
  itime(5) = 0
  itime(6) = 0
  itimel = itime

  delta_t = 60

  call jcup_init_time(itime)


  !!call mpi_finalize(i)
  !!stop

  call set_and_put_data(0)

  call dynamics_init()

  call land_put_initial_data()

end subroutine atm_init

!======================================================================================================

subroutine set_and_put_data(step)
  use field_def, only : set_send_data_2d, set_send_data_3d
  implicit none
  integer, intent(IN) :: step
  integer :: k

  call set_send_data_2d("atm","atm_grid_2d", field%send_2d(:,:), step, 1)
  call jcup_put_data(field%varp(1)%varp_ptr, pack(field%send_2d, MASK = field%mask2d))
  call set_send_data_2d("atm","atm_grid_2d", field%send_2d(:,:), step, 1)
  call jcup_put_data(field%varp(2)%varp_ptr, pack(field%send_2d, MASK = field%mask2d))
  call set_send_data_2d("atm","atm_grid_2d", field%send_2d(:,:), step, 1)
  call jcup_put_data(field%varp(3)%varp_ptr, pack(field%send_2d, MASK = field%mask2d))

  do k = 1, GN25
    call set_send_data_2d("atm","atm_grid_2d", field%send_25d(:,:,k), step, k+3)
    field%buffer25d(:,k) = pack(field%send_25d(:,:,k), MASK = field%mask2d)  
  end do

  call jcup_put_data(field%varp(4)%varp_ptr, field%buffer25d, GN25) 

  do k = 1, GN25
    call set_send_data_2d("atm","atm_grid_2d", field%send_25d(:,:,k), step, k+4)
    field%buffer25d(:,k) = pack(field%send_25d(:,:,k), MASK = field%mask2d)  
  end do

  call jcup_put_data(field%varp(5)%varp_ptr, field%buffer25d, GN25) 


  call set_send_data_3d("atm","atm_grid_3d", field3d%send_3d(:,:,:), step, 1)
  call jcup_put_data(field3d%varp(1)%varp_ptr, pack(field3d%send_3d, MASK = field3d%mask3d))


end subroutine set_and_put_data

!======================================================================================================

subroutine get_and_write_data()
  use field_def, only : write_data_2d, write_data_3d
  implicit none

  field%buffer1d(:) = 0.d0

  call jcup_get_data(field%varg(1)%varg_ptr, field%buffer1d)
  field%recv_2d = unpack(field%buffer1d, field%mask2d, field%recv_2d)
  call write_data_2d("atm","atm_grid_2d", "oa_1", field%recv_2d)

  field3d%buffer1d(:) = 0.d0

  call jcup_get_data(field3d%varg(1)%varg_ptr, field3d%buffer1d)
  field3d%recv_3d = unpack(field3d%buffer1d, field3d%mask3d, field3d%recv_3d)
  call write_data_3d("atm","atm_grid_3d","ca_1", field3d%recv_3d)

  field_land%buffer1d(:) = 0.d0

  call jcup_get_data(field_land%varg(1)%varg_ptr, field_land%buffer1d)
  field_land%recv_2d = unpack(field_land%buffer1d, field_land%mask2d, field_land%recv_2d)
  call write_data_2d("atm","atm_grid_2d", "la_1", field_land%recv_2d)

  field_land%buffer1d(:) = 0.d0

  call jcup_get_data(field_land%varg(2)%varg_ptr, field_land%buffer1d)
  field_land%recv_2d = unpack(field_land%buffer1d, field_land%mask2d, field_land%recv_2d)
  call write_data_2d("atm","atm_grid_2d", "ia_1", field_land%recv_2d)


end subroutine get_and_write_data

!======================================================================================================

subroutine atm_run(loop_flag)
  use field_def
  use dynamics, only : dynamics_run
  use land, only : land_run
  implicit none
  logical, intent(INOUT) :: loop_flag
  integer :: i, k

  do i = 1, 6

    call jcup_set_time("atm", itime, delta_t)

    call get_and_write_data()

    call set_and_put_data(i)

    call jcup_inc_time("atm", itime)

    call land_run(loop_flag)

  end do

  loop_flag = .false.
  call dynamics_run()

end subroutine atm_run

!======================================================================================================

subroutine atm_fin()
  use jcup_interface
  use dynamics, only : dynamics_fin
  implicit none
  integer :: i

  !call mpi_finalize(i)
  call jcup_coupling_end(itime,.true.)
  call dynamics_fin()

end subroutine atm_fin

!======================================================================================================


end module atm


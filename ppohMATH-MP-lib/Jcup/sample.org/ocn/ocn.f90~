module ocn
use jcup_interface
use field_common
use component_field, only : component_field_type
private

public :: ocn_init
public :: ocn_run
public :: ocn_fin

integer :: DIV_X
integer :: DIV_Y
integer :: my_comm, my_group, my_rank, my_size

type(component_field_type) :: field

integer :: send_grid_ol(GNXL*GNYL)
integer :: recv_grid_ol(GNXL*GNYL)
integer :: send_grid_lo(GNXO*GNYO)
integer :: recv_grid_lo(GNXO*GNYO)

integer :: send_grid_oi(GNXI*GNYI)
integer :: recv_grid_oi(GNXI*GNYI)
integer :: send_grid_io(GNXO*GNYO)
integer :: recv_grid_io(GNXO*GNYO)


integer :: itime(6)
integer :: delta_t

contains

!======================================================================================================

subroutine ocn_init()
  use jcup_interpolation_test 
  use field_def
  use component_field, only : init_field, init_field_data
  use ice, only : ice_init_grid, ice_init_data, ice_put_initial_data
  implicit none
  integer, allocatable :: grid_index(:)
  integer :: lis, lie, ljs, lje
  integer :: i
  integer :: comp_id(2)


  call jcup_set_new_comp("ocn")
  call jcup_set_new_comp("ice")
  call jcup_initialize("ocn")

  call init_interpolation(6,1,2)

  call jcup_get_mpi_parameter("ocn", my_comm, my_group, my_size, my_rank)
  call cal_mn(my_size, DIV_X, DIV_Y)

  call init_field_def(2)

  call set_field_def(component_name = "ocn", grid_name = "ocn_grid", &
                     g_nx = GNXO, g_ny = GNYO, g_nz = 1, hallo = 2, div_x = DIV_X, div_y = DIV_Y)
  call get_local_field(component_name = "ocn", grid_name = "ocn_grid", &
                       local_is = lis, local_ie = lie, local_js = ljs, local_je = lje)

  call init_field(field, "ocn_grid", lis, lie, ljs, lje, 1, 1)
  call cal_grid_index("ocn","ocn_grid", field%grid_index)


  call jcup_def_grid(field%grid_index, "ocn", "ocn_grid")

  call ice_init_grid()


  call jcup_end_grid_def()


  call init_field_data(field, GN25, 2, 7)

  call jcup_def_varp(field%varp(1)%varp_ptr, "ocn_1", "ocn_grid")
  call jcup_def_varp(field%varp(2)%varp_ptr, "oi_1", "ocn_grid")
  call jcup_def_varg(field%varg(1)%varg_ptr, "atm_1", "ocn_grid", 1)
  call jcup_def_varg(field%varg(2)%varg_ptr, "atm_2", "ocn_grid", 1)
  call jcup_def_varg(field%varg(3)%varg_ptr, "atm_3", "ocn_grid", 1)
  call jcup_def_varg(field%varg(4)%varg_ptr, "atm_4", "ocn_grid", GN25)
  call jcup_def_varg(field%varg(5)%varg_ptr, "atm_5", "ocn_grid", GN25)
  call jcup_def_varg(field%varg(6)%varg_ptr, "land_1", "ocn_grid", 1)
  call jcup_def_varg(field%varg(7)%varg_ptr, "ice_1", "ocn_grid", 1)


  call ice_init_data()


  call jcup_end_var_def()

  call jcup_set_mapping_table("atm", "atm", "atm_grid_2d", "ocn", "ocn_grid", 1)
  call jcup_set_mapping_table("atm", "ocn", "ocn_grid", "atm", "atm_grid_2d", 1)
  call set_operation_index("ocn","atm",1)


  call set_grid_mapping("ocn", "ocn_grid", GNXO, GNYO, "ice", "ice_grid", GNXI, GNYI, send_grid_oi,recv_grid_oi)
  call set_grid_mapping("ice", "ice_grid", GNXI, GNYI, "ocn", "ocn_grid", GNXO, GNYO, send_grid_io,recv_grid_io)

  call jcup_set_mapping_table("ocn", "ocn", "ocn_grid", "ice", "ice_grid", 1, send_grid_oi, recv_grid_oi)
  call jcup_set_mapping_table("ocn", "ice", "ice_grid", "ocn", "ocn_grid", 1, send_grid_io, recv_grid_io)
  call set_operation_index("ocn","ice",1)
  call set_operation_index("ice","ocn",1)

  call jcup_set_mapping_table("atm", "atm", "atm_grid_2d", "ice", "ice_grid", 1)
  call jcup_set_mapping_table("atm", "ice", "ice_grid", "atm", "atm_grid_2d", 1)
  call set_operation_index("ice","atm",1)

  call set_grid_mapping("ocn", "ocn_grid", GNXO, GNYO, "land", "land_grid", GNXL, GNYL, send_grid_ol,recv_grid_ol)
  call set_grid_mapping("land", "land_grid", GNXL, GNYL, "ocn", "ocn_grid", GNXO, GNYO, send_grid_lo,recv_grid_lo)
  call jcup_set_mapping_table("ocn", "ocn", "ocn_grid", "land", "land_grid", 1, send_grid_ol, recv_grid_ol)
  call jcup_set_mapping_table("ocn", "land", "land_grid", "ocn", "ocn_grid", 1, send_grid_lo, recv_grid_lo)
  call set_operation_index("ocn","land",1)

  call jcup_set_mapping_table("land", "land", "land_grid", "ice", "ice_grid", 1)
  call jcup_set_mapping_table("land", "ice", "ice_grid", "land", "land_grid", 1)
  call set_operation_index("ice","land",1)


  

  itime(1) = 2004
  itime(2) = 12
  itime(3) = 31
  itime(4) = 0
  itime(5) = 0
  itime(6) = 0

  delta_t = 180

  call jcup_init_time(itime)

  !!call mpi_finalize(i)
  !!stop

  call set_and_put_data(0)

  call ice_put_initial_data()

end subroutine ocn_init

!======================================================================================================

subroutine set_and_put_data(step)
  use field_def, only : set_send_data_2d
  implicit none
  integer, intent(IN) :: step
  integer :: k

  call set_send_data_2d("ocn","ocn_grid", field%send_2d(:,:), step, 3)
  call jcup_put_data(field%varp(1)%varp_ptr, pack(field%send_2d, MASK = field%mask2d))
  call jcup_put_data(field%varp(2)%varp_ptr, pack(field%send_2d, MASK = field%mask2d))

end subroutine set_and_put_data

!======================================================================================================

subroutine get_and_write_data()
  use field_def, only : write_data_2d
  implicit none
  integer :: k

  field%buffer25d = 0.d0
  field%recv_25d = 0.d0

  field%buffer1d(:) = 0.d0

  call jcup_get_data(field%varg(1)%varg_ptr, field%buffer1d)
  field%recv_2d(:,:) = unpack(field%buffer1d, field%mask2d, field%recv_2d)
  call write_data_2d("ocn","ocn_grid", "atm_1", field%recv_2d)

  field%buffer1d(:) = 0.d0

  call jcup_get_data(field%varg(2)%varg_ptr, field%buffer1d)
  field%recv_2d(:,:) = unpack(field%buffer1d, field%mask2d, field%recv_2d)
  call write_data_2d("ocn","ocn_grid", "atm_2", field%recv_2d)

  field%buffer1d(:) = 0.d0

  call jcup_get_data(field%varg(3)%varg_ptr, field%buffer1d)
  field%recv_2d(:,:) = unpack(field%buffer1d, field%mask2d, field%recv_2d)
  call write_data_2d("ocn","ocn_grid", "atm_3", field%recv_2d)

  call jcup_get_data(field%varg(4)%varg_ptr, field%buffer25d, GN25)
  do k = 1, GN25
    field%recv_25d(:,:,k) = unpack(field%buffer25d(:,k), field%mask2d, field%recv_25d(:,:,k))
  end do
  do k = 1, GN25
    call write_data_2d("ocn","ocn_grid", "atm_4", field%recv_25d(:,:,k))
  end do

  call jcup_get_data(field%varg(5)%varg_ptr, field%buffer25d, GN25)
  do k = 1, GN25
    field%recv_25d(:,:,k) = unpack(field%buffer25d(:,k), field%mask2d, field%recv_25d(:,:,k))
  end do
  do k = 1, GN25
    call write_data_2d("ocn","ocn_grid", "atm_5", field%recv_25d(:,:,k))
  end do

  field%buffer1d(:) = 0.d0

  call jcup_get_data(field%varg(6)%varg_ptr, field%buffer1d)
  field%recv_2d(:,:) = unpack(field%buffer1d, field%mask2d, field%recv_2d)
  call write_data_2d("ocn","ocn_grid", "land_1", field%recv_2d)

  field%buffer1d(:) = 0.d0
  call jcup_get_data(field%varg(7)%varg_ptr, field%buffer1d)
  field%recv_2d(:,:) = unpack(field%buffer1d, field%mask2d, field%recv_2d)
  call write_data_2d("ocn","ocn_grid", "ice_1", field%recv_2d)

end subroutine get_and_write_data

!======================================================================================================

subroutine ocn_run(loop_flag)
  use field_def
  use ice, only : ice_run
  implicit none
  logical, intent(INOUT) :: loop_flag
  integer :: i, k

  do i = 1, 2

   call jcup_set_time("ocn", itime, delta_t)

    call get_and_write_data()

    call set_and_put_data(i)

    call jcup_inc_time("ocn", itime)

    call ice_run(loop_flag)

  end do

  loop_flag = .false.

end subroutine ocn_run

!======================================================================================================

subroutine ocn_fin()
  use jcup_interface
  implicit none
  integer :: i
  
  call jcup_coupling_end(itime, .true.)

end subroutine ocn_fin

!======================================================================================================


end module ocn

